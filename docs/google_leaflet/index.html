<!DOCTYPE html>
<html lang='ja'>
<head>
	<meta charset='UTF-8' name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>
	<meta name="author" content="仁志">
	<meta name="keywords" content="leaflet, GoogleAppsScript, gis">	
	<meta name="description" content='スプレッドシートとleafletの連携テストです。'>
	<meta property="og:title" content="スプレッドシートとleafletの連携テスト" />
	<meta property="og:type" content="website" />
	<meta property="og:image" content="" />
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="スプレッドシートとleafletの連携テスト" />
	<meta name="twitter:image" content="" />

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

	<script type="text/javascript" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/linkevery2s/sourcecode@main/leaflet/marker_color/marker_color.js"></script>
	<link rel = "stylesheet" type = "text/css" href = "https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
	<link rel = "stylesheet" type = "text/css" href = "https://unpkg.com/leaflet.markercluster@1.4.1/dist//MarkerCluster.Default.css">

<style>

	html, body, #map{
		width: 100%;
		height: 100%;
		padding: 0;
		margin: 0;
	}

</style>

<title>スプレッドシートとleafletの連携テスト</title>

<script type="module">

	onload = async () => {

		const map = L.map('map');

		const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		}).addTo(map);

		const id = "AKfycbxpCn3QXNMXrY__QFWMx-HAUhBFx9Q-Bd2hlkWpfM2kK_FU0M2GCTbp3tdVWjeGldiq";

		const res = await fetch("https://script.google.com/macros/s/" + id + "/exec");
		const data = await res.json();

		let pref= L.geoJSON(data,{onEachFeature: popup_pin, pointToLayer: blue}).addTo(map);

		/* Clustergroup Add */
		let markers = L.markerClusterGroup({disableClusteringAtZoom: 13});
		markers.addLayer(pref);
		map.addLayer(markers);

		map.fitBounds(markers.getBounds());

	}

	/* Popup Display */
	let popup_pin = (feature, layer) => {
		let popup;
		if (feature.properties && feature.properties.place) {
			popup = "施設名：" + feature.properties.place;

			if(feature.properties.overview != ""){
				popup += "<br>" + feature.properties.overview;
			}else{}

			if(feature.properties.photo != ""){
				popup += "<img src='https://drive.google.com/uc?export=view&id=" + feature.properties.photo + "' width='100%'>";
			}else{}

			if(feature.properties.url != ""){
				popup += "<br><a href='" + feature.properties.url +  " target='_blank'>url</a>"; 
			}else{}

		}else{};

		layer.bindPopup(popup);
	}

</script>


</head>
<body>
	<div id='map'></div>
	
</body>
</html>
